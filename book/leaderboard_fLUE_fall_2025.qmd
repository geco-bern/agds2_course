# Leaderboard fLUE {#sec-leaderboard}

## Fall 2025

This is the leaderboard for the fall of 2025 fractional Light Use Efficiency (fLUE) competition. 
Submissions are required, but the competition is amicable as rankings will only be considered in the general context of grading. 

### Available data

The full data set contains fLUE values of 70 sites.
Training and test data sets were generated by splitting the full data set in an 
80/20 ratio.

### Leaderboard submission

Your model should be able to run on the test data set, hence you can only use 
predictors therein and features derived thereof.
Submit your model results predicting fLUE for the test dataset as a CSV file 
containing a table of model results.

```{r echo = FALSE}
library(archive)
library(kableExtra)
library(tibble)
# demo data
demo <- tribble(
  ~site, ~date, ~flue_pred,
  "AR-Vir", "2010-02-09", 0.5, 
  'AR-Vir', "2010-02-11", 0.6, 
  'AR-Vir', "2010-02-26", 0.6, 
  '...',    "2025-12-01",  NA,
  'ZM-Mon', "2009-07-14", 0.5
)

# plot the matrix as a leaderboard table
kbl(demo) |>
  kable_styling(
    full_width = FALSE
  )
```

Leaderboard submissions will be accepted two (2) times during the semester, with a final submission included with your overall report. The CSV file submitted **via pull request** to [this repo](https://github.com/geco-bern/agds2_course) should be named `xyz_results.csv` (with xyz replaced by your github username), and put in the `data/leaderboard/fLUE_fall_2025/` folder. Submissions via email will not be considered.

## Leaderboard

```{r echo=TRUE, message = FALSE, warning = FALSE, error = FALSE, include = FALSE}
library(stringr)
library(dplyr)
# install.packages("remotes")
# remotes::install_github("geco-bern/rgeco")
library(rgeco)
library(yardstick)

# check if on github
ON_GIT <- ifelse(
  Sys.getenv("GITHUB_ACTION") == "",
  FALSE,
  TRUE
)

# if not on git generate demo files
if(!ON_GIT) {
 
  # # Use stored results as reference (not part of the repository):
  ref_df <- read.csv("~/Desktop/reference_results_fLUE.csv") |> tibble()
} else {
  
  # # Use encrypted, stored results as reference (part of the repository)
  # use pw to de-zip the encripted zip file
  pw <- Sys.getenv("fLUE")
  ref_df <- read.csv(
    archive_read(here("data/leaderboard/fLUE_fall_2025/reference_results_fLUE.csv.zip"), 
                 "reference_results_fLUE.csv", 
                 password = pw)
    ) |> tibble()
}

# list csv file in data/leaderboard/fall_2025
files <- list.files(
  here::here("data/leaderboard/fLUE_fall_2025"),
  "*.csv$",
  full.names = TRUE
  )
# loop over all files
lb <- lapply(files, function(file){
  # set users
  user <- gsub("_results.csv", "", basename(file))
    
  # read in leaderboard submission
  modelled <- read.csv(file, header = TRUE) |> tibble()
  
  # calculate SKILL data.frame()
  skills <- try(
    {
      df_pred_obs <- dplyr::inner_join(
        ref_df, 
        modelled,
        by = join_by(site, date))
      stopifnot(nrow(df_pred_obs) == 25310)
      
      out <- suppressWarnings(
        rgeco::analyse_modobs2(
          df_pred_obs |> rename('obs' = 'flue_ref',
                            'pred' = 'flue_pred'),
          # mod = "flue_pred",
          # obs = "flue",
          mod = "pred",
          obs = "obs",
          
          type = "hex",
          pal = "magma",
          shortsubtitle = TRUE
        )
      )
      # out$gg
      out$df_metrics |> mutate(User = user)
    }, 
  )
  
  # trap confusion matrix errors (if any)
  if(inherits(skills, "try-error")){
    return(NULL)
  } else {
    return(skills)
  }
})

# bind rows
lb <- dplyr::bind_rows(lb)
```

```{r echo=FALSE, message = FALSE, warning = FALSE, error = FALSE}
# print(here::here()) # NOTE: on GitHub runner this resulted in "/home/runner/work/agds2_course/agds2_course"

if(!is.null(lb)) {
  # format the skills:
  lb <- lb |>
    dplyr::select(User, .metric, .estimate) |>
    tidyr::pivot_wider(names_from = .metric, values_from = .estimate)
   
  # order rows from high to low
  lb <- lb |> 
    dplyr::arrange(dplyr::desc(rsq)) |>
    dplyr::select(User, rsq, rmse, slope) |>
    # and round to reasonable number of digits
    dplyr::mutate(dplyr::across(dplyr::where(is.double), \(x) round(x, 3)))

  # plot the matrix as a leaderboard table
  kbl(
    lb,
    row.names = FALSE,
    caption = "The leaderboard ranked according to highest r-squared score. A random dataset is included as a reference."
  ) |>
    kable_styling(
      bootstrap_options = "striped",
      full_width = TRUE
    ) |>
    footnote(
      ifelse(ON_GIT,
             "This table was automatically generated! Updates after submission can take over 10 minutes.",
             "This table was automatically generated! Updates after submission require manual upgrade."
             )
    )
}
```

