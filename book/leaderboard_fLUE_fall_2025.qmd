# Leaderboard fLUE {#sec-leaderboard}

## Fall 2025

This is the leaderboard for the fall of 2025 fractional Light Use Efficiency (fLUE) competition. 
Submissions are required, but the competition is amicable as rankings will only be considered in the general context of grading. 

### Available data

The full data set contains fLUE values of 70 sites.
Training and test data sets were generated by splitting the full data set in an 
80/20 ratio.

### Leaderboard submission

Your model should be able to run on the test data set, hence you can only use 
predictors therein and features derived thereof.
Submit your model results predicting fLUE for the test dataset as a CSV file 
containing a table of model results.

```{r echo = FALSE}
library(archive)
library(kableExtra)
library(tibble)
# demo data
demo <- tribble(
  ~site, ~date, ~flue_pred,
  "AR-Vir", "2010-02-09", 0.5, 
  'AR-Vir', "2010-02-11", 0.6, 
  'AR-Vir', "2010-02-26", 0.6, 
  '...',    "2025-12-01",  NA,
  'ZM-Mon', "2009-07-14", 0.5
)

# plot the matrix as a leaderboard table
kbl(demo) |>
  kable_styling(
    full_width = FALSE
  )
```

Leaderboard submissions will be accepted two (2) times during the semester, with a final submission included with your overall report. The CSV file submitted **via pull request** to [this repo](https://github.com/geco-bern/agds2_course) should be named `xyz_results.csv` (with xyz replaced by your github username), and put in the `data/leaderboard/fLUE_fall_2025/` folder. Submissions via email will not be considered.

## Leaderboard
```{r}
#| include: false

#' Analyse modelled values versus observed data.
#'
#' Calculates a set of performance statistics and optionally creates plots of modelled
#' versus observed values.
#'
#' @param df A data frame containing columns with names corresponding to arguments
#' \code{mod} and \code{obs}
#' @param mod A character string specifying the variable name (column) of the
#' modelled (simulated) values in data frame \code{df}.
#' @param obs A character string specifying the variable name (column) of the
#' observed values in data frame \code{df}.
#'
analyse_modobs2_metrics <- function(
  df,
  mod,
  obs,
  ...) {

  ## rename to 'mod' and 'obs' and remove rows with NA in mod or obs
  df <- df %>%
    as_tibble() %>%
    ungroup() %>%
    dplyr::select(all_of(c(mod = mod, obs = obs))) %>%
    tidyr::drop_na(mod, obs)

  ## get linear regression (coefficients)
  linmod <- lm(obs ~ mod, data = df)

  ## construct metrics table using the 'yardstick' library
  df_metrics <- df %>%
    yardstick::metrics(obs, mod) %>%
    dplyr::bind_rows(tibble(.metric = "n", .estimator = "standard", .estimate = summarise(df, numb = n()) %>% unlist())) %>%
    dplyr::bind_rows(tibble(.metric = "slope", .estimator = "standard", .estimate = coef(linmod)[2])) %>%
    # dplyr::bind_rows( tibble( .metric = "nse",      .estimator = "standard", .estimate = hydroGOF::NSE( obs, mod, na.rm=TRUE ) ) ) %>%
    dplyr::bind_rows(tibble(.metric = "mean_obs", .estimator = "standard", .estimate = summarise(df, mean = mean(obs, na.rm = TRUE)) %>% unlist())) %>%
    dplyr::bind_rows(tibble(
      .metric = "prmse", .estimator = "standard",
      .estimate = dplyr::filter(., .metric == "rmse") %>% dplyr::select(.estimate) %>% unlist() /
        dplyr::filter(., .metric == "mean_obs") %>%
        dplyr::select(.estimate) %>%
        unlist()
    )) %>%
    dplyr::bind_rows(tibble(
      .metric = "pmae", .estimator = "standard",
      .estimate = dplyr::filter(., .metric == "mae") %>% dplyr::select(.estimate) %>% unlist() /
        dplyr::filter(., .metric == "mean_obs") %>%
        dplyr::select(.estimate) %>%
        unlist()
    )) %>%
    dplyr::bind_rows(tibble(.metric = "bias", .estimator = "standard", .estimate = dplyr::summarise(df, mean((mod - obs), na.rm = TRUE)) %>% unlist())) %>%
    dplyr::bind_rows(tibble(.metric = "pbias", .estimator = "standard", .estimate = dplyr::summarise(df, mean((mod - obs) / obs, na.rm = TRUE)) %>% unlist()))

  return(list(df_metrics = df_metrics))
}
```

```{r echo=TRUE, message = FALSE, warning = FALSE, error = FALSE, include = FALSE}
library(stringr)
library(dplyr)
library(yardstick)

# check if on github
ON_GIT <- ifelse(
  Sys.getenv("GITHUB_ACTION") == "",
  FALSE,
  TRUE
)

# if not on git generate demo files
if(!ON_GIT) {
 
  # # Use stored results as reference (not part of the repository):
  ref_df <- read.csv("../drought_predictors_competition_reference_results_fLUE.csv") |> tibble()
  
} else {
  
  # # Use encrypted, stored results as reference (part of the repository)
  # use pw to de-zip the encripted zip file
  # pw <- Sys.getenv("fLUE")
  # ref_df <- read.csv(
  #   archive::archive_read(
  #     archive = here::here("book/images/reference_results_fLUE.csv.zip"), 
  #     file = "reference_results_fLUE.csv", 
  #     password = pw)
  #   ) |> tibble()
}

# list csv file in data/leaderboard/fall_2025
files <- list.files(
  here::here("data/leaderboard/fLUE_fall_2025"),
  "*.csv$",
  full.names = TRUE
  )
# loop over all files
lb <- lapply(files, function(file){
  # set users
  user <- gsub("_results.csv", "", basename(file))

  # read in leaderboard submission
  modelled <- read.csv(file, header = TRUE) |> tibble()
  
  # fix modelled values, if site and date are missing by assuming same order
  if (ncol(modelled)==1){
    names(modelled) <- "flue_pred"
    stopifnot(nrow(modelled) == 17777)
    modelled <- modelled |> 
      mutate(site = ref_df$site,
             date = ref_df$date)
  }
  
  # calculate SKILL data.frame()
  skills <- try(
    {
      df_pred_obs <- dplyr::inner_join(
        ref_df,
        modelled,
        by = join_by(site, date))

      out <- analyse_modobs2_metrics(
          df_pred_obs,
          mod = "flue_pred",
          obs = "flue_ref")
      out$df_metrics |> mutate(User = user)
    },
  )

  # trap confusion matrix errors (if any)
  if(inherits(skills, "try-error")){
    return(NULL)
  } else {
    return(skills)
  }
})

# bind rows
lb <- dplyr::bind_rows(lb)
```

```{r echo=FALSE, message = FALSE, warning = FALSE, error = FALSE}
# print(here::here()) # NOTE: on GitHub runner this resulted in "/home/runner/work/agds2_course/agds2_course"

if(!is.null(lb)) {
  # format the skills:
  lb <- lb |>
    dplyr::select(User, .metric, .estimate) |>
    tidyr::pivot_wider(names_from = .metric, values_from = .estimate)
   
  # order rows from high to low
  lb <- lb |> 
    dplyr::arrange(dplyr::desc(rsq)) |>
    dplyr::select(User, rsq, rmse, slope) |>
    # and round to reasonable number of digits
    dplyr::mutate(dplyr::across(dplyr::where(is.double), \(x) round(x, 3)))

  # plot the matrix as a leaderboard table
  kbl(
    lb,
    row.names = FALSE,
    caption = "The leaderboard ranked according to highest r-squared score. A random dataset is included as a reference."
  ) |>
    kable_styling(
      bootstrap_options = "striped",
      full_width = TRUE
    ) |>
    footnote(
      ifelse(ON_GIT,
             "This table was automatically generated! Updates after submission can take over 10 minutes.",
             "This table was manually generated! Updates after submission require manual upgrade."
             )
    )
}
```

